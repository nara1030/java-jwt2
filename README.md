## 목표
```txt
1. 로그인한 사용자에 따라 서로 다른 메뉴가 노출된다.
   (시큐리티 기본 폼 로그인 양식 사용)
2. 로그인 성공 이후 JWT 토큰이 발급되고, 이후 타 API에 대해서는 토큰 검증 후 접근 허용된다.
```

## 기록
```txt
먼저 스프링 시큐리티 설정에 대해서..

1. 폼 로그인 방식을 선택했기에, UsernamePasswordAuthenticationFilter가 실행된다.
   다만, 폼 로그인 방식임에도 로그인 성공 시 토큰 발급하므로 세션 기반 로그인 방식은 아니다.
2. 로그인 성공 후 JWT 발급, URL 접근 시 JWT 여부 검증 위해 Filter 추가한다.
   전자는 로그인 필터 뒤, 후자는 앞에 두어서 로그인 필터가 인증 사용자에 대해 중복 처리하지 않도록 하였다.
   이 과정들은 꼭 Filter가 아니더라도 Provider를 커스터마이징할 수도 있다고 알고 있으나, 좀 더 흔한 방식을 택했다[A].
3. 토큰 검증 시 토큰 내 사용자명이 있는지, 유효한 토큰인지만 확인했다.
   토큰, SecurityContext에 대한 지식이 부족해서 최초엔 토큰 검증 로직[B]에서 SecurityContextHolder를 이용했다.
   하지만 SecurityContext는 각 요청에 대해 독립적(thread-local)이며, 요청이 종료되면 유효하지 않아 세션과는 다르다는 걸 런타임 에러가 터지고 다시 인지했다.

메뉴, 그리고 타임리프에 관해서는..

1. 흔히 관계형 DB로 권한에 대해 관리했었는데, 공통 작업을 해본 적이 없기도 하고 이를 시큐리티와 연동해보고 싶었다.
   관계형 DB라면 ROLE, USER, MENU 이렇게 분리하여 ROLE에 코드성 데이터를 놨을 거 같은데..
   ROLE을 ENUM으로 뺀 후 DB 사용은 조금 번잡할 거 같아서 USER, MENU 데이터는 JSON 파일로 로드했다.
   이때 ENUM에 커스텀하게 권한을 추가하고, 시큐리티에서 그걸 연동하고 싶었다[C][D].
2. 최초 페이지(/)에서 유저와 방문객이 보는 메뉴를 다르게 노출하고 싶었다.
   처음 생각은 모든 메뉴를 페이지에 뿌리고, 화면단에서 ROLE 정보를 받아 노출을 제어하고 싶었다.
   그런데 타임리프에서 hasRole 함수 내부에 동적 파라미터 전달에서 에러가 발생하여[E],
   차선책으로 서버에서 유저 권한에 따라 메뉴를 필터링해서 뿌려주도록 하였다[F].
3. 타임리프에서 페이지 안 바꾸고, 안에 BODY만 바꾸는 방법 확인해보자.
   사이드바 등 공통적으로 필요한 부분은 변하지 않으니..

중요하진 않지만 추후 방향..

1. 해보니 든 생각인데 JWT로 테스트하기 위해서는 프론트, 백이 분리되어야 할 거 같다.
   (현재 로그인 이후 POSTMAN으로 발급된 토큰을 함께 넘겨주어 테스트까지만 진행했다.)
   프론트에서 메뉴 데이터를 로드하고, 백에서 인증인가 및 API 로직이 있어야 할 거 같다.
   이때, 메뉴 데이터 로드 시 URL 정보도 추가해서 보완해야겠다 생각이 들었다.
2. 이렇게 분리하게 되면 응답 및 요청 스펙도 중요해질 거 같고,
   서버 개발자라면 어떻게 공통화할건지 한 번 고민해봐야 할 거 같다.
3. 지금은 로그인 성공 시 단순 JWT 발급인데, OAUTH2 즉 SSO 개념(맞나..?)으로 들어가면
   발급된 토큰으로 다른 서버(MSA처럼?)가 모두 허용되어야 할 거 같다.
   이거 해보려고 한 거긴 한데.. 이거는 꼭 고민해봐야 될 거 같다.
4. 별개로 멀티모듈 한 번 해보려고 했으나..
   딱 어떤 상황에 써야 하는지 몰라서 안함..

----
A. Provider를 여러 개 두어서 인증 시 비밀번호, 지문 등 여러 개를 놔둘 수도 있다고 하는데 이는 추후 구현해보고 싶다.
   support 등 메소드 사용법 정확히 몰라서..
B. Chat GPT 없었으면 코드를 빨리 짤 수 있었을까 싶다.
   나처럼 내향적이고, 주변에 개발자가 많이 없는 사람에게 엄청난 시니어가 옆에서 조언해주는 것 같은 느낌을 받게 해주다니..
C. 현재 4개의 권한이 있고, 방문객 권한으로 ANONYMOUS가 있는데 이는 원래 UNREGISTERED였다.
   시큐리티가 ANONYMOUS가 아니면 못 읽는 거 같아서 수정해주었는데 원래 하고 싶었던 건 아니었다...
D. 용어가 맞는지 모르겠으나, 역할보다 세부적인 권한 정보(WRITE, READ 등)도 사용해보고 싶다.
   SI하면 이벤트 버튼 등에 사용자마다 권한이 다르게 들어가 있는 경우가 있던데..
   정확히 언제 필요했는지 떠오르지가 않네..
E. sec:authorize 태그에서 hasRole 함수 내부에 동적 파라미터를 전달하는 것은 불가능하다고 Chat GPT가..
F. 이 로직도 Chat GPT 도움을 받긴 했는데, 더 간단하게 짤 수 있나 싶기도 하고..

```




